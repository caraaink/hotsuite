<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Instagram Scheduler</title>
    <link rel="stylesheet" href="/style.css">
</head>
<body>
    <div class="container">
        <h2>Jadwalkan Posting Instagram</h2>
        <form id="scheduleForm" class="upload-form">
            <label for="accountId">Pilih Akun IG:</label>
            <select id="accountId" name="accountId" required>
                <option value="">-- Pilih Akun --</option>
            </select>
            <label for="userToken">User Token:</label>
            <select id="userToken" name="userToken" required>
                <option value="">-- Pilih Token --</option>
            </select>
            <label for="githubFolder">Pilih Folder di GitHub:</label>
            <select id="githubFolder" name="githubFolder">
                <option value="ig">-- Pilih Folder --</option>
            </select>
            <label for="githubFile">Pilih File:</label>
            <select id="githubFile" name="githubFile" required>
                <option value="">-- Pilih File --</option>
            </select>
            <label for="mediaUrl">URL Media (Otomatis dari GitHub):</label>
            <input type="text" id="mediaUrl" name="mediaUrl" placeholder="URL akan diisi otomatis" readonly required>
            <label for="caption">Caption:</label>
            <textarea id="caption" name="caption" placeholder="Masukkan caption" required></textarea>
            <label for="time">Waktu Posting:</label>
            <input type="datetime-local" id="time" name="time" required>
            <button type="submit" class="upload-btn">Jadwalkan</button>
        </form>
        <div class="status-container">
            <div id="spinner" class="spinner hidden"></div>
            <p id="status"></p>
        </div>

        <!-- Bagian untuk menampilkan daftar jadwal -->
        <h2>Daftar Jadwal Posting</h2>
        <div id="scheduleList" class="schedule-list">
            <table>
                <thead>
                    <tr>
                        <th>Akun IG</th>
                        <th>Media URL</th>
                        <th>Caption</th>
                        <th>Waktu Posting</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="scheduleTableBody"></tbody>
            </table>
        </div>
    </div>

    <script>
        const form = document.getElementById('scheduleForm');
        const status = document.getElementById('status');
        const spinner = document.getElementById('spinner');
        const accountId = document.getElementById('accountId');
        const userToken = document.getElementById('userToken');
        const githubFolder = document.getElementById('githubFolder');
        const githubFile = document.getElementById('githubFile');
        const mediaUrl = document.getElementById('mediaUrl');
        const scheduleTableBody = document.getElementById('scheduleTableBody');

        // Load tokens dari environment variables via API
        fetch('/api/refresh-token')
            .then(res => {
                if (!res.ok) {
                    throw new Error(`HTTP error! status: ${res.status}`);
                }
                return res.json();
            })
            .then(data => {
                console.log('Tokens fetched:', data);
                const tokens = data.updatedTokens;
                if (!tokens || Object.keys(tokens).length === 0) {
                    throw new Error('No tokens returned from server');
                }
                for (let i = 1; i <= 11; i++) {
                    if (tokens[`TOKEN_${i}`]) {
                        const option = document.createElement('option');
                        option.value = tokens[`TOKEN_${i}`];
                        option.textContent = `Akun ${i}`;
                        option.dataset.accountNum = i; // Simpan nomor akun di dataset
                        userToken.appendChild(option);
                    }
                }
                if (userToken.options.length === 1) {
                    status.innerText = 'No tokens available. Please check environment variables.';
                }
            })
            .catch(err => {
                status.innerText = `Error loading tokens: ${err.message}`;
                console.error('Error fetching tokens:', err);
            });

        userToken.addEventListener('change', async () => {
            const token = userToken.value;
            const selectedOption = userToken.options[userToken.selectedIndex];
            const accountNum = selectedOption.dataset.accountNum; // Ambil nomor akun dari dataset
            console.log('Selected token:', token, 'Account number:', accountNum);

            if (!token || !accountNum) {
                accountId.innerHTML = '<option value="">-- Pilih Akun --</option>';
                return;
            }

            try {
                const res = await fetch(`/api/get_accounts?account_key=Akun ${accountNum}`);
                if (!res.ok) {
                    throw new Error(`HTTP error! status: ${res.status}`);
                }
                const data = await res.json();
                console.log('Accounts fetched:', data);
                accountId.innerHTML = '<option value="">-- Pilih Akun --</option>';
                if (data.accounts && data.accounts[`Akun ${accountNum}`]) {
                    data.accounts[`Akun ${accountNum}`].accounts.forEach(acc => {
                        if (acc.type === 'ig') {
                            const option = document.createElement('option');
                            option.value = acc.id;
                            option.textContent = acc.name;
                            accountId.appendChild(option);
                        }
                    });
                } else {
                    status.innerText = 'No Instagram accounts found for this token.';
                }
            } catch (error) {
                status.innerText = `Error fetching accounts: ${error.message}`;
                console.error('Error fetching accounts:', error);
            }
        });

        // Load GitHub folders
        async function loadGithubFolders() {
            try {
                const res = await fetch('/api/get_github_files?path=ig');
                if (!res.ok) {
                    throw new Error(`HTTP error! status: ${res.status}`);
                }
                const data = await res.json();
                console.log('GitHub folders fetched:', data);
                githubFolder.innerHTML = '<option value="ig">-- Pilih Folder --</option>';
                data.files.forEach(item => {
                    if (item.type === 'dir') {
                        const option = document.createElement('option');
                        option.value = item.path;
                        option.textContent = item.name;
                        githubFolder.appendChild(option);
                    }
                });
            } catch (error) {
                status.innerText = `Error loading GitHub folders: ${error.message}`;
                console.error('Error fetching GitHub folders:', error);
            }
        }

        // Load GitHub files when folder is selected
        githubFolder.addEventListener('change', async () => {
            const folderPath = githubFolder.value;
            if (!folderPath) {
                githubFile.innerHTML = '<option value="">-- Pilih File --</option>';
                mediaUrl.value = '';
                return;
            }

            try {
                const res = await fetch(`/api/get_github_files?path=${folderPath}`);
                if (!res.ok) {
                    throw new Error(`HTTP error! status: ${res.status}`);
                }
                const data = await res.json();
                console.log('GitHub files fetched:', data);
                githubFile.innerHTML = '<option value="">-- Pilih File --</option>';
                data.files.forEach(item => {
                    if (item.type === 'file' && (item.name.endsWith('.jpg') || item.name.endsWith('.png') || item.name.endsWith('.mp4'))) {
                        const option = document.createElement('option');
                        option.value = item.download_url;
                        option.textContent = item.name;
                        githubFile.appendChild(option);
                    }
                });
            } catch (error) {
                status.innerText = `Error loading GitHub files: ${error.message}`;
                console.error('Error fetching GitHub files:', error);
            }
        });

        // Set media URL when file is selected
        githubFile.addEventListener('change', () => {
            const fileUrl = githubFile.value;
            mediaUrl.value = fileUrl || '';
        });

        // Load folders on page load
        loadGithubFolders();

        // Load schedules on page load
        async function loadSchedules() {
            try {
                const res = await fetch('/api/get_schedules');
                if (!res.ok) {
                    throw new Error(`HTTP error! status: ${res.status}`);
                }
                const data = await res.json();
                console.log('Schedules fetched:', data);
                scheduleTableBody.innerHTML = '';
                if (data.schedules && data.schedules.length > 0) {
                    data.schedules.forEach(schedule => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${schedule.accountId}</td>
                            <td><a href="${schedule.mediaUrl}" target="_blank">Lihat Media</a></td>
                            <td>${schedule.caption}</td>
                            <td>${new Date(schedule.time).toLocaleString()}</td>
                            <td>${schedule.completed ? 'Selesai' : 'Menunggu'}</td>
                        `;
                        scheduleTableBody.appendChild(row);
                    });
                } else {
                    scheduleTableBody.innerHTML = '<tr><td colspan="5">Belum ada jadwal.</td></tr>';
                }
            } catch (error) {
                status.innerText = `Error loading schedules: ${error.message}`;
                console.error('Error fetching schedules:', error);
            }
        }

        // Load schedules when page loads
        loadSchedules();

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            status.innerText = 'Menjadwalkan...';
            spinner.classList.remove('hidden');

            const formData = {
                accountId: accountId.value,
                mediaUrl: mediaUrl.value,
                caption: document.getElementById('caption').value,
                time: document.getElementById('time').value,
                userToken: userToken.value,
            };

            try {
                const response = await fetch('/api/schedule', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData),
                });
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const result = await response.json();
                status.innerText = result.message || 'Gagal menjadwalkan!';
                // Refresh daftar jadwal setelah menjadwalkan
                loadSchedules();
            } catch (error) {
                status.innerText = `Error: ${error.message}`;
                console.error('Error scheduling post:', error);
            } finally {
                spinner.classList.add('hidden');
            }
        });
    </script>
</body>
</html>
