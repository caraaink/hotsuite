<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Instagram Scheduler</title>
    <link rel="stylesheet" href="/style.css">
</head>
<body>
    <div class="container">
        <!-- Tombol untuk toggle dark mode -->
        <button id="themeToggle" class="theme-toggle-btn">🌙 Dark Mode</button>

        <h2>Jadwalkan Posting Instagram</h2>
        <form id="scheduleForm" class="upload-form">
            <label for="userAccount">Pilih Akun:</label>
            <select id="userAccount" name="userAccount" required>
                <option value="">-- Pilih Akun --</option>
                <option value="1">Akun 1</option>
                <option value="2">Akun 2</option>
                <option value="3">Akun 3</option>
                <option value="4">Akun 4</option>
                <option value="5">Akun 5</option>
                <option value="6">Akun 6</option>
                <option value="7">Akun 7</option>
                <option value="8">Akun 8</option>
                <option value="9">Akun 9</option>
                <option value="10">Akun 10</option>
                <option value="11">Akun 11</option>
            </select>

            <label for="accountId">Pilih Username IG:</label>
            <select id="accountId" name="accountId" required>
                <option value="">-- Pilih Username --</option>
            </select>

            <label for="githubFolder">Pilih Folder di GitHub:</label>
            <select id="githubFolder" name="githubFolder">
                <option value="ig">-- Pilih Folder --</option>
            </select>

            <label for="githubSubfolder">Pilih Subfolder:</label>
            <select id="githubSubfolder" name="githubSubfolder">
                <option value="">-- Pilih Subfolder --</option>
            </select>

            <label for="githubFile">Pilih File:</label>
            <select id="githubFile" name="githubFile" required>
                <option value="">-- Pilih File --</option>
            </select>

            <label for="mediaUrl">URL Media (Otomatis dari GitHub):</label>
            <input type="text" id="mediaUrl" name="mediaUrl" placeholder="URL akan diisi otomatis" readonly required>

            <label for="caption">Caption:</label>
            <textarea id="caption" name="caption" placeholder="Masukkan caption" required></textarea>

            <label for="time">Waktu Posting:</label>
            <input type="datetime-local" id="time" name="time" required>

            <button type="submit" class="upload-btn">Jadwalkan</button>
        </form>

        <div class="status-container">
            <div id="spinner" class="spinner hidden"></div>
            <p id="status"></p>
        </div>

        <!-- Bagian untuk menampilkan daftar jadwal -->
        <h2>Daftar Jadwal Posting</h2>
        <div id="scheduleList" class="schedule-list">
            <table>
                <thead>
                    <tr>
                        <th>Akun IG</th>
                        <th>Media URL</th>
                        <th>Caption</th>
                        <th>Waktu Posting</th>
                        <th>Status</th>
                        <th>Aksi</th>
                    </tr>
                </thead>
                <tbody id="scheduleTableBody"></tbody>
            </table>
        </div>
    </div>

    <script>
        const form = document.getElementById('scheduleForm');
        const status = document.getElementById('status');
        const spinner = document.getElementById('spinner');
        const accountId = document.getElementById('accountId');
        const userAccount = document.getElementById('userAccount');
        const githubFolder = document.getElementById('githubFolder');
        const githubSubfolder = document.getElementById('githubSubfolder');
        const githubFile = document.getElementById('githubFile');
        const mediaUrl = document.getElementById('mediaUrl');
        const caption = document.getElementById('caption');
        const scheduleTableBody = document.getElementById('scheduleTableBody');
        const timeInput = document.getElementById('time');
        const themeToggle = document.getElementById('themeToggle');
        let selectedToken = null; // Simpan token yang dipilih
        let selectedUsername = null; // Simpan username yang dipilih
        let allSubfolders = []; // Simpan daftar subfolder
        let allMediaFiles = []; // Simpan semua file media di subfolder yang dipilih

        // Load dark mode preference from localStorage
        if (localStorage.getItem('theme') === 'dark') {
            document.body.classList.add('dark-mode');
            themeToggle.textContent = '☀️ Light Mode';
        }

        // Toggle dark mode
        themeToggle.addEventListener('click', () => {
            document.body.classList.toggle('dark-mode');
            const isDarkMode = document.body.classList.contains('dark-mode');
            themeToggle.textContent = isDarkMode ? '☀️ Light Mode' : '🌙 Dark Mode';
            localStorage.setItem('theme', isDarkMode ? 'dark' : 'light');
        });

        // Load Instagram usernames when an account is selected
        userAccount.addEventListener('change', async () => {
            const accountNum = userAccount.value;
            console.log('Selected account number:', accountNum);

            if (!accountNum) {
                accountId.innerHTML = '<option value="">-- Pilih Username --</option>';
                selectedToken = null;
                selectedUsername = null;
                return;
            }

            try {
                const tokenRes = await fetch(`/api/refresh-token?accountNum=${accountNum}`);
                if (!tokenRes.ok) {
                    throw new Error(`HTTP error fetching token! status: ${tokenRes.status}`);
                }
                const tokenData = await tokenRes.json();
                console.log('Token fetched:', tokenData);
                selectedToken = tokenData.token;
                if (!selectedToken) {
                    throw new Error('No token found for this account');
                }

                const accountsRes = await fetch(`/api/get_accounts?account_key=Akun ${accountNum}`);
                if (!accountsRes.ok) {
                    throw new Error(`HTTP error fetching accounts! status: ${accountsRes.status}`);
                }
                const accountsData = await accountsRes.json();
                console.log('Accounts fetched:', accountsData);

                accountId.innerHTML = '<option value="">-- Pilih Username --</option>';
                if (accountsData.accounts && accountsData.accounts[`Akun ${accountNum}`]) {
                    const igAccounts = accountsData.accounts[`Akun ${accountNum}`].accounts;
                    console.log('IG accounts:', igAccounts);
                    if (igAccounts && igAccounts.length > 0) {
                        igAccounts.forEach(acc => {
                            if (acc.type === 'ig' && acc.username) {
                                const option = document.createElement('option');
                                option.value = acc.id;
                                option.textContent = acc.username;
                                option.dataset.username = acc.username; // Simpan username di dataset
                                accountId.appendChild(option);
                            }
                        });
                        if (accountId.options.length === 1) {
                            status.innerText = 'No Instagram accounts found for this account.';
                        }
                    } else {
                        status.innerText = 'No Instagram accounts found for this account.';
                    }
                } else {
                    status.innerText = 'No accounts data found for this account.';
                }
            } catch (error) {
                status.innerText = `Error fetching accounts: ${error.message}`;
                console.error('Error fetching accounts:', error);
            }
        });

        // Simpan username saat memilih akun IG
        accountId.addEventListener('change', () => {
            const selectedOption = accountId.options[accountId.selectedIndex];
            selectedUsername = selectedOption ? selectedOption.dataset.username : null;
            console.log('Selected username:', selectedUsername);
        });

        // Fungsi untuk natural sort
        function naturalSort(a, b) {
            const aKey = a.name || a.path || a;
            const bKey = b.name || b.path || b;
            return aKey.localeCompare(bKey, undefined, { numeric: true, sensitivity: 'base' });
        }

        // Load GitHub folders directly from GitHub API
        async function loadGithubFolders() {
            status.innerText = 'Memuat daftar folder...';
            spinner.classList.remove('hidden');
            try {
                const res = await fetch('/api/get_github_files?path=ig');
                if (!res.ok) {
                    throw new Error(`HTTP error! status: ${res.status}`);
                }
                const data = await res.json();
                console.log('GitHub folders fetched:', data);

                const folders = data.files.filter(item => item.type === 'dir');
                folders.sort(naturalSort);

                githubFolder.innerHTML = '<option value="ig">-- Pilih Folder --</option>';
                folders.forEach(item => {
                    console.log('Adding folder to dropdown:', item.name);
                    const option = document.createElement('option');
                    option.value = item.path;
                    option.textContent = item.name;
                    githubFolder.appendChild(option);
                });

                if (githubFolder.options.length === 1) {
                    status.innerText = 'No subfolders found in ig directory.';
                } else {
                    status.innerText = '';
                }
            } catch (error) {
                status.innerText = `Error loading GitHub folders: ${error.message}`;
                console.error('Error fetching GitHub folders:', error);
            } finally {
                spinner.classList.add('hidden');
            }
        }

        // Load subfolders when a folder is selected
        async function fetchSubfolders(path) {
            status.innerText = 'Memuat daftar subfolder...';
            spinner.classList.remove('hidden');
            try {
                const res = await fetch(`/api/get_github_files?path=${path}`);
                if (!res.ok) {
                    throw new Error(`HTTP error! status: ${res.status}`);
                }
                const data = await res.json();
                console.log(`Subfolders fetched for path ${path}:`, data);

                allSubfolders = [];
                data.files.forEach(item => {
                    if (item.type === 'dir') {
                        allSubfolders.push({
                            name: item.name,
                            path: item.path,
                        });
                    }
                });

                allSubfolders.sort(naturalSort);
                return allSubfolders;
            } catch (error) {
                console.error(`Error fetching subfolders for path ${path}:`, error);
                status.innerText = `Error loading subfolders: ${error.message}`;
                return [];
            } finally {
                spinner.classList.add('hidden');
            }
        }

        // Load files in the selected subfolder
        async function fetchFilesInSubfolder(path) {
            status.innerText = 'Memuat daftar file...';
            spinner.classList.remove('hidden');
            try {
                const res = await fetch(`/api/get_github_files?path=${path}`);
                if (!res.ok) {
                    throw new Error(`HTTP error! status: ${res.status}`);
                }
                const data = await res.json();
                console.log(`Files fetched for path ${path}:`, data);

                allMediaFiles = [];
                data.files.forEach(item => {
                    if (item.type === 'file' && (item.name.endsWith('.jpg') || item.name.endsWith('.png') || item.name.endsWith('.mp4'))) {
                        allMediaFiles.push({
                            name: item.name,
                            path: item.path,
                            download_url: item.download_url,
                        });
                    }
                });

                allMediaFiles.sort(naturalSort);
                return allMediaFiles;
            } catch (error) {
                console.error(`Error fetching files for path ${path}:`, error);
                status.innerText = `Error loading files: ${error.message}`;
                return [];
            } finally {
                spinner.classList.add('hidden');
            }
        }

        // Load subfolders when folder is selected
        githubFolder.addEventListener('change', async () => {
            const folderPath = githubFolder.value;
            if (!folderPath) {
                githubSubfolder.innerHTML = '<option value="">-- Pilih Subfolder --</option>';
                githubFile.innerHTML = '<option value="">-- Pilih File --</option>';
                mediaUrl.value = '';
                caption.value = '';
                return;
            }

            try {
                const subfolders = await fetchSubfolders(folderPath);
                console.log('All subfolders found:', subfolders);

                if (subfolders.length === 0) {
                    const files = await fetchFilesInSubfolder(folderPath);
                    githubSubfolder.innerHTML = '<option value="">-- Tidak Ada Subfolder --</option>';
                    githubFile.innerHTML = '<option value="">-- Pilih File --</option>';
                    files.forEach(file => {
                        const option = document.createElement('option');
                        option.value = JSON.stringify(file);
                        option.textContent = file.name;
                        githubFile.appendChild(option);
                    });

                    if (githubFile.options.length === 1) {
                        status.innerText = 'No supported media files found in this folder.';
                    } else {
                        status.innerText = '';
                    }
                } else {
                    githubSubfolder.innerHTML = '<option value="">-- Pilih Subfolder --</option>';
                    subfolders.forEach(subfolder => {
                        const option = document.createElement('option');
                        option.value = subfolder.path;
                        option.textContent = subfolder.name;
                        githubSubfolder.appendChild(option);
                    });

                    githubFile.innerHTML = '<option value="">-- Pilih File --</option>';
                    mediaUrl.value = '';
                    caption.value = '';

                    if (githubSubfolder.options.length === 1) {
                        status.innerText = 'No subfolders found in this folder.';
                    } else {
                        status.innerText = '';
                    }
                }
            } catch (error) {
                status.innerText = `Error loading subfolders: ${error.message}`;
                console.error('Error fetching subfolders:', error);
            }
        });

        // Load files when subfolder is selected
        githubSubfolder.addEventListener('change', async () => {
            const subfolderPath = githubSubfolder.value;
            if (!subfolderPath) {
                githubFile.innerHTML = '<option value="">-- Pilih File --</option>';
                mediaUrl.value = '';
                caption.value = '';
                return;
            }

            try {
                const files = await fetchFilesInSubfolder(subfolderPath);
                console.log('All media files found:', files);

                githubFile.innerHTML = '<option value="">-- Pilih File --</option>';
                files.forEach(file => {
                    const option = document.createElement('option');
                    option.value = JSON.stringify(file);
                    option.textContent = file.name;
                    githubFile.appendChild(option);
                });

                if (githubFile.options.length === 1) {
                    status.innerText = 'No supported media files found in this subfolder.';
                } else {
                    status.innerText = '';
                }
            } catch (error) {
                status.innerText = `Error loading files: ${error.message}`;
                console.error('Error fetching files:', error);
            }
        });

        // Set media URL and fetch caption when file is selected
        githubFile.addEventListener('change', async () => {
            const fileData = githubFile.value ? JSON.parse(githubFile.value) : null;
            if (!fileData) {
                mediaUrl.value = '';
                caption.value = '';
                return;
            }

            mediaUrl.value = fileData.download_url;
            status.innerText = 'Fetching caption...';

            try {
                const folderPath = fileData.path.substring(0, fileData.path.lastIndexOf('/'));
                const metaFileName = `${fileData.name}.meta.json`;
                const metaPath = `${folderPath}/${metaFileName}`;

                const metaRes = await fetch(`/api/get_file_content?path=${metaPath}`);
                if (!metaRes.ok) {
                    throw new Error(`Failed to fetch ${metaFileName}: ${metaRes.status}`);
                }
                const metaData = await metaRes.json();
                console.log(`${metaFileName} content:`, metaData);

                if (metaData && metaData.caption) {
                    caption.value = metaData.caption;
                    status.innerText = '';
                } else {
                    caption.value = '';
                    status.innerText = `No caption found in ${metaFileName}.`;
                }
            } catch (error) {
                caption.value = '';
                status.innerText = `Error fetching caption: ${error.message}`;
                console.error('Error fetching metadata:', error);
            }
        });

        // Load folders on page load
        loadGithubFolders();

        // Fungsi untuk menghapus jadwal
        async function deleteSchedule(index) {
            try {
                const res = await fetch('/api/delete_schedule', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ index }),
                });
                if (!res.ok) {
                    throw new Error(`HTTP error! status: ${res.status}`);
                }
                const result = await res.json();
                status.innerText = result.message || 'Jadwal berhasil dihapus!';
                await loadSchedules();
            } catch (error) {
                status.innerText = `Error deleting schedule: ${error.message}`;
                console.error('Error deleting schedule:', error);
            }
        }

        // Fungsi untuk mengedit jadwal
        async function editSchedule(index) {
            try {
                const res = await fetch('/api/get_schedules');
                if (!res.ok) {
                    throw new Error(`HTTP error fetching schedules! status: ${res.status}`);
                }
                const data = await res.json();
                const schedules = data.schedules || [];
                const schedule = schedules[index];

                if (!schedule) {
                    status.innerText = 'Jadwal tidak ditemukan.';
                    return;
                }

                // Isi form dengan data jadwal
                userAccount.value = schedule.accountNum || '';
                // Setelah memilih userAccount, kita perlu memuat ulang daftar username
                await new Promise(resolve => {
                    const changeEvent = new Event('change');
                    userAccount.dispatchEvent(changeEvent);
                    setTimeout(resolve, 500); // Tunggu hingga daftar username dimuat
                });

                // Set accountId dan pastikan username sesuai
                accountId.value = schedule.accountId;
                selectedUsername = schedule.username;
                mediaUrl.value = schedule.mediaUrl;
                caption.value = schedule.caption;
                timeInput.value = schedule.time;
                selectedToken = schedule.userToken;

                // Set form ke mode edit
                form.dataset.editIndex = index;
                form.querySelector('.upload-btn').textContent = 'Simpan Perubahan';
                status.innerText = 'Mengedit jadwal...';
            } catch (error) {
                status.innerText = `Error loading schedule for edit: ${error.message}`;
                console.error('Error loading schedule for edit:', error);
            }
        }

        // Load schedules on page load
        async function loadSchedules() {
            try {
                scheduleTableBody.innerHTML = '<tr><td colspan="6">Memuat jadwal...</td></tr>';
                const res = await fetch('/api/get_schedules');
                if (!res.ok) {
                    throw new Error(`HTTP error fetching schedules! status: ${res.status}`);
                }
                const data = await res.json();
                console.log('Schedules fetched:', data);

                scheduleTableBody.innerHTML = '';
                const schedules = data.schedules || [];

                if (schedules.length > 0) {
                    schedules.forEach((schedule, index) => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${schedule.username || schedule.accountId}</td>
                            <td><a href="${schedule.mediaUrl}" target="_blank">Lihat Media</a></td>
                            <td>${schedule.caption}</td>
                            <td>${new Date(schedule.time).toLocaleString()}</td>
                            <td>${schedule.completed ? 'Selesai' : 'Menunggu'}</td>
                            <td>
                                <button class="edit-btn" data-index="${index}" ${schedule.completed ? 'disabled' : ''}>Edit</button>
                                <button class="delete-btn" data-index="${index}">Hapus</button>
                            </td>
                        `;
                        scheduleTableBody.appendChild(row);
                    });

                    document.querySelectorAll('.edit-btn').forEach(button => {
                        button.addEventListener('click', (e) => {
                            const index = parseInt(e.target.getAttribute('data-index'), 10);
                            editSchedule(index);
                        });
                    });

                    document.querySelectorAll('.delete-btn').forEach(button => {
                        button.addEventListener('click', (e) => {
                            const index = parseInt(e.target.getAttribute('data-index'), 10);
                            if (confirm('Apakah Anda yakin ingin menghapus jadwal ini?')) {
                                deleteSchedule(index);
                            }
                        });
                    });
                } else {
                    scheduleTableBody.innerHTML = '<tr><td colspan="6">Belum ada jadwal.</td></tr>';
                }
            } catch (error) {
                status.innerText = `Error loading schedules: ${error.message}`;
                console.error('Error fetching schedules:', error);
                scheduleTableBody.innerHTML = '<tr><td colspan="6">Gagal memuat jadwal.</td></tr>';
            }
        }

        loadSchedules();

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            status.innerText = form.dataset.editIndex ? 'Menyimpan perubahan...' : 'Menjadwalkan...';
            spinner.classList.remove('hidden');

            const formData = {
                accountId: accountId.value,
                username: selectedUsername, // Simpan username
                mediaUrl: mediaUrl.value,
                caption: caption.value,
                time: timeInput.value,
                userToken: selectedToken,
                accountNum: userAccount.value,
                completed: false,
            };

            try {
                if (form.dataset.editIndex) {
                    const index = parseInt(form.dataset.editIndex, 10);
                    const res = await fetch('/api/update_schedule', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ index, updatedSchedule: formData }),
                    });
                    if (!res.ok) {
                        throw new Error(`HTTP error updating schedule! status: ${res.status}`);
                    }
                    const result = await res.json();
                    status.innerText = result.message || 'Jadwal berhasil diperbarui!';
                    delete form.dataset.editIndex;
                    form.querySelector('.upload-btn').textContent = 'Jadwalkan';
                } else {
                    const response = await fetch('/api/schedule', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(formData),
                    });
                    if (!response.ok) {
                        throw new Error(`HTTP error scheduling post! status: ${response.status}`);
                    }
                    const result = await response.json();
                    status.innerText = result.message || 'Jadwal berhasil ditambahkan!';
                }

                // Reset form
                form.reset();
                accountId.innerHTML = '<option value="">-- Pilih Username --</option>';
                githubFolder.value = 'ig';
                githubSubfolder.innerHTML = '<option value="">-- Pilih Subfolder --</option>';
                githubFile.innerHTML = '<option value="">-- Pilih File --</option>';
                mediaUrl.value = '';
                caption.value = '';
                selectedUsername = null;

                await loadSchedules();
            } catch (error) {
                status.innerText = `Error: ${error.message}`;
                console.error('Error scheduling post:', error);
            } finally {
                spinner.classList.add('hidden');
            }
        });
    </script>
</body>
</html>
