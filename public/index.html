<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Instagram Poster</title>
    <link rel="stylesheet" href="/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    <div class="container">
        <header>
            <h2>Instagram Poster</h2>
            <button id="themeToggle" class="theme-btn">
                <i class="fas fa-moon"></i>
            </button>
        </header>
        <main>
            <select id="accountSelect" name="accountId">
                <option value="">Pilih Akun Instagram</option>
                <option value="17841472299141470" data-username="_cika.cantika">Cika Cantika (_cika.cantika)</option>
                <option value="17841469780026465" data-username="raisa.ayunda_">Raisa Ayunda (raisa.ayunda_)</option>
                <option value="17841472886987230" data-username="meownimev2">Meownime (meownimev2)</option>
                <option value="17841402777728356" data-username="meownime.official">Meownime (meownime.official)</option>
            </select>

            <select id="postTarget" name="postTarget">
                <option value="both">Facebook & Instagram</option>
                <option value="instagram">Instagram Saja</option>
                <option value="facebook">Facebook Saja</option>
            </select>

            <input type="file" id="imageInput" name="photo" accept="image/*" onchange="validateFile()">
            <input type="text" id="imageUrl" name="imageUrl" placeholder="Atau masukkan link gambar (harus berakhiran .jpg, .jpeg, atau .png)">
            <textarea id="caption" name="caption" placeholder="Masukkan caption"></textarea>
            <button onclick="uploadToInstagram()" class="upload-btn">Upload</button>

            <div class="status-container">
                <div id="spinner" class="spinner hidden"></div>
                <p id="status"></p>
            </div>
        </main>
    </div>

    <script>
        const themeToggle = document.getElementById("themeToggle");
        themeToggle.addEventListener("click", () => {
            document.body.classList.toggle("dark-mode");
            const icon = themeToggle.querySelector("i");
            icon.classList.toggle("fa-moon");
            icon.classList.toggle("fa-sun");
            localStorage.setItem("theme", document.body.classList.contains("dark-mode") ? "dark" : "light");
        });

        if (localStorage.getItem("theme") === "dark") {
            document.body.classList.add("dark-mode");
            themeToggle.querySelector("i").classList.replace("fa-moon", "fa-sun");
        }

        function validateFile() {
            const fileInput = document.getElementById("imageInput");
            const statusText = document.getElementById("status");
            if (fileInput.files.length > 0 && fileInput.files[0].size === 0) {
                statusText.innerText = "Gagal: File gambar kosong atau tidak valid!";
                fileInput.value = ""; // Reset input jika tidak valid
            }
        }

        // Validasi URL gambar
        function validateImageUrl(url) {
            const imageExtensions = /\.(jpg|jpeg|png)$/i;
            const isValidUrl = url.startsWith("https://") && imageExtensions.test(url);
            return isValidUrl;
        }

        function showSpinner() {
            document.getElementById("spinner").classList.remove("hidden");
        }

        function hideSpinner() {
            document.getElementById("spinner").classList.add("hidden");
        }

        // Fungsi untuk mengubah nama file menjadi format yang lebih aman
        function sanitizeFileName(file) {
            const timestamp = Date.now();
            const extension = file.name.split('.').pop().toLowerCase();
            const newFileName = `image-${timestamp}.${extension}`;
            return new File([file], newFileName, { type: file.type });
        }

        async function uploadToImgBB(file) {
            const sanitizedFile = sanitizeFileName(file);
            const formData = new FormData();
            formData.append("image", sanitizedFile);
            formData.append("key", "a54b42bd860469def254d13b8f55f43e");

            const response = await fetch("https://api.imgbb.com/1/upload", {
                method: "POST",
                body: formData
            });

            const result = await response.json();
            if (!result.success) {
                throw new Error("Gagal mengunggah ke ImgBB: " + JSON.stringify(result));
            }
            return result.data.url;
        }

        async function uploadToInstagram() {
            const accountId = document.getElementById("accountSelect").value;
            const postTarget = document.getElementById("postTarget").value;
            const fileInput = document.getElementById("imageInput").files[0];
            let imageUrl = document.getElementById("imageUrl").value;
            const caption = document.getElementById("caption").value;
            const statusText = document.getElementById("status");

            if (!accountId) {
                statusText.innerText = "Gagal: Pilih akun Instagram terlebih dahulu!";
                return;
            }

            if (!fileInput && !imageUrl) {
                statusText.innerText = "Gagal: Harap unggah file gambar atau masukkan link gambar!";
                return;
            }

            if (fileInput && fileInput.size === 0) {
                statusText.innerText = "Gagal: File gambar kosong atau tidak valid!";
                return;
            }

            // Validasi URL jika dimasukkan secara manual
            if (imageUrl && !validateImageUrl(imageUrl)) {
                statusText.innerText = "Gagal: Link gambar harus menggunakan HTTPS dan berakhiran .jpg, .jpeg, atau .png!";
                return;
            }

            statusText.innerText = "Mengunggah...";
            showSpinner();

            try {
                // Jika ada file, unggah ke ImgBB dari frontend
                if (fileInput) {
                    imageUrl = await uploadToImgBB(fileInput);
                }

                // Kirim data ke backend
                const formData = new FormData();
                formData.append("accountId", accountId);
                formData.append("imageUrl", imageUrl);
                formData.append("caption", caption);
                formData.append("postTarget", postTarget);

                const response = await fetch("/api/upload?login=emi", {
                    method: "POST",
                    body: formData
                });

                const result = await response.json();
                if (response.ok) {
                    statusText.innerText = result.message;
                } else {
                    statusText.innerText = `Gagal: ${result.message}`;
                    if (result.message.includes("Media tidak dapat diambil dari URI")) {
                        statusText.innerText += " Coba gunakan nama file yang lebih pendek dan hindari karakter khusus.";
                    }
                }
            } catch (error) {
                statusText.innerText = "Gagal: " + error.message;
            } finally {
                hideSpinner();
            }
        }
    </script>
    <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'91e4db88ee1a7486',t:'MTc0MTYzMTE1Ni4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script>
</body>
</html>
